// Telegram WebApp init
const tg = window.Telegram?.WebApp;
if (tg) tg.expand();

const WEBHOOK_URL = "/.netlify/functions/results";
const params = new URLSearchParams(location.search);
const CLIENT_ID = params.get("client_id") || null;
const GROUP = params.get("group") || "default";
const SUBJECT = (params.get("subject") || "rus").toLowerCase();

// ===== Inline SVG –¥–ª—è –∑–∞–¥–∞—á–∏ —Å –∫–ª–µ—Ç–∫–∞–º–∏ (–û–ì–≠ ‚Ññ4) =====
const GRID_SVG = `
<svg width="240" height="200" viewBox="0 0 240 200" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <pattern id="gridPattern" width="20" height="20" patternUnits="userSpaceOnUse">
      <path d="M20 0H0V20" fill="none" stroke="#555" stroke-width="0.5"/>
    </pattern>
  </defs>

  <!-- –°–µ—Ç–∫–∞ -->
  <rect x="0" y="0" width="240" height="200" fill="url(#gridPattern)" />

  <!-- –î–≤–µ –±–µ–ª—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã -->
  <path d="M40 100 L220 55" stroke="#ffffff" stroke-width="2" />
  <path d="M40 100 L220 165" stroke="#ffffff" stroke-width="2" />

  <!-- –û—Ç—Ä–µ–∑–æ–∫ AB (—Å–¥–≤–∏–Ω—É—Ç –Ω–∞ 20px –≤–ø—Ä–∞–≤–æ) -->
  <line x1="60" y1="90" x2="60" y2="100" stroke="#ff6b73" stroke-width="4" stroke-linecap="round"/>

  <!-- –ü–æ–¥–ø–∏—Å–∏ (—Ç–æ–∂–µ —á—É—Ç—å —Å–¥–≤–∏–≥–∞–µ–º –≤–ø—Ä–∞–≤–æ, —á—Ç–æ–±—ã —Å–æ–≤–ø–∞–ª–∏) -->
  <text x="50" y="88" fill="#ffffff" font-size="12" font-family="Inter, Arial">A</text>
  <text x="50" y="103" fill="#ffffff" font-size="12" font-family="Inter, Arial">B</text>
</svg>`;

// ==================== –ë–ê–ù–ö –í–û–ü–†–û–°–û–í ====================
const BANKS = {
  // === –†–£–°–°–ö–ò–ô –û–ì–≠ ===
  rus_oge: [
    {
      id: "rq1",
      topic: "–°–∂–∞—Ç–∏–µ —Ç–µ–∫—Å—Ç–∞",
      text: "–°–∫–æ–ª—å–∫–æ –ø—Ä–∏—ë–º–æ–≤ —Å–∂–∞—Ç–∏—è —Ç–µ–∫—Å—Ç–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç? –í –æ—Ç–≤–µ—Ç –∑–∞–ø–∏—à–∏—Ç–µ —Ü–∏—Ñ—Ä—É.",
      options: ["1) 2", "2) 3", "3) 5"],
      correct: [2]
    },
    {
      id: "rq2",
      topic: "–ì—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Å–Ω–æ–≤–∞",
      text: `(1)–û–¥–Ω–∏–º –∏–∑ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –ª–∂–µ–Ω–∞—É—á–Ω—ã—Ö –æ–±–æ–±—â–µ–Ω–∏–π —è–≤–ª—è–µ—Ç—Å—è –æ—Ç—Ä–∏—Ü–∞–Ω–∏–µ –æ–ø—ã—Ç–∞ –∏ —Ç–µ–æ—Ä–∏–∏ –≤—Å–µ–π –ø—Ä–µ–¥—ã–¥—É—â–µ–π –Ω–∞—É–∫–∏. (2)–ù–∞ —Å–∞–º–æ–º –¥–µ–ª–µ —Å —ç—Ç–∏–º –Ω–µ–ª—å–∑—è —Å–æ–≥–ª–∞—Å–∏—Ç—å—Å—è: –Ω–æ–≤–æ–µ –≤ –Ω–∞—É–∫–µ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—ã–≤–∞–µ—Ç –ø—Ä–æ—Å—Ç–æ –æ—Ç—Ä–∏—Ü–∞–Ω–∏–µ–º —Å—Ç–∞—Ä–æ–≥–æ. (3)–ù–æ–≤–æ–µ ‚Äì —ç—Ç–æ –ª–∏—à—å —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ, —É–≥–ª—É–±–ª–µ–Ω–∏–µ –∏ –æ–±–æ–±—â–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –≤ —Å–≤—è–∑–∏ —Å –Ω–æ–≤—ã–º–∏ —Å—Ñ–µ—Ä–∞–º–∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è. (4)–ï—Å–ª–∏ –±—ã –Ω–æ–≤–∞—è —Ç–µ–æ—Ä–∏—è –Ω–∞—á–∏—Å—Ç–æ –æ—Ç—Ä–∏—Ü–∞–ª–∞ —Å–ª–æ–∂–∏–≤—à–∏–µ—Å—è –∑–Ω–∞–Ω–∏—è, –Ω–∞—É–∫–∞ –≤–æ–æ–±—â–µ –Ω–µ —Å–º–æ–≥–ª–∞ –±—ã —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è. (5)–ë–µ–∑ –æ–ø–æ—Ä—ã –Ω–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ø—Ä–µ–¥—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤ –ª—é–±–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è —Å—Ç–∞–ª–∞ –±—ã –ø—Ä–µ—Ç–µ–Ω–¥–æ–≤–∞—Ç—å –Ω–∞ –∏—Å—Ç–∏–Ω—É, –∏ —Å—Ç–∞–ª –±—ã –≤–æ–∑–º–æ–∂–µ–Ω –ø–æ–ª–Ω—ã–π —Ä–∞–∑–≥—É–ª –≤–æ–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ —á—É–≤—Å—Ç–≤ —É—á—ë–Ω–æ–≥–æ.<br><br>–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã, –≥–¥–µ –≤–µ—Ä–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Å–Ω–æ–≤–∞.`,
      options: [
        "1) ¬´–æ–¥–Ω–∏–º –∏–∑ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ —è–≤–ª—è–µ—Ç—Å—è –æ—Ç—Ä–∏—Ü–∞–Ω–∏–µ¬ª (1)",
        "2) ¬´–Ω–µ–ª—å–∑—è —Å–æ–≥–ª–∞—Å–∏—Ç—å—Å—è¬ª (2)",
        "3) ¬´–æ–±–æ–±—â–µ–Ω–∏–µ¬ª (3)",
        "4) ¬´—Ç–µ–æ—Ä–∏—è –æ—Ç—Ä–∏—Ü–∞–ª–∞¬ª (4)",
        "5) ¬´—Å—Ç–∞–ª –±—ã –≤–æ–∑–º–æ–∂–µ–Ω —Ä–∞–∑–≥—É–ª¬ª (5)"
      ],
      correct: [1, 2, 5]
    },
    {
      id: "rq3",
      topic: "–°–ª–æ–∂–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è",
      text: `(1)–û–¥–Ω–∏–º –∏–∑ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –ª–∂–µ–Ω–∞—É—á–Ω—ã—Ö –æ–±–æ–±—â–µ–Ω–∏–π —è–≤–ª—è–µ—Ç—Å—è –æ—Ç—Ä–∏—Ü–∞–Ω–∏–µ –æ–ø—ã—Ç–∞ –∏ —Ç–µ–æ—Ä–∏–∏ –≤—Å–µ–π –ø—Ä–µ–¥—ã–¥—É—â–µ–π –Ω–∞—É–∫–∏. (2)–ù–∞ —Å–∞–º–æ–º –¥–µ–ª–µ —Å —ç—Ç–∏–º –Ω–µ–ª—å–∑—è —Å–æ–≥–ª–∞—Å–∏—Ç—å—Å—è: –Ω–æ–≤–æ–µ –≤ –Ω–∞—É–∫–µ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—ã–≤–∞–µ—Ç –ø—Ä–æ—Å—Ç–æ –æ—Ç—Ä–∏—Ü–∞–Ω–∏–µ–º —Å—Ç–∞—Ä–æ–≥–æ. (3)–ù–æ–≤–æ–µ ‚Äì —ç—Ç–æ –ª–∏—à—å —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ, —É–≥–ª—É–±–ª–µ–Ω–∏–µ –∏ –æ–±–æ–±—â–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –≤ —Å–≤—è–∑–∏ —Å –Ω–æ–≤—ã–º–∏ —Å—Ñ–µ—Ä–∞–º–∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è. (4)–ï—Å–ª–∏ –±—ã –Ω–æ–≤–∞—è —Ç–µ–æ—Ä–∏—è –Ω–∞—á–∏—Å—Ç–æ –æ—Ç—Ä–∏—Ü–∞–ª–∞ —Å–ª–æ–∂–∏–≤—à–∏–µ—Å—è –∑–Ω–∞–Ω–∏—è, –Ω–∞—É–∫–∞ –≤–æ–æ–±—â–µ –Ω–µ —Å–º–æ–≥–ª–∞ –±—ã —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è. (5)–ë–µ–∑ –æ–ø–æ—Ä—ã –Ω–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ø—Ä–µ–¥—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤ –ª—é–±–∞—è —Ñ–∞–Ω—Ç–∞—Å—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è —Å—Ç–∞–ª–∞ –±—ã –ø—Ä–µ—Ç–µ–Ω–¥–æ–≤–∞—Ç—å –Ω–∞ –∏—Å—Ç–∏–Ω—É, –∏ —Å—Ç–∞–ª –±—ã –≤–æ–∑–º–æ–∂–µ–Ω –ø–æ–ª–Ω—ã–π —Ä–∞–∑–≥—É–ª –≤–æ–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ —á—É–≤—Å—Ç–≤ —É—á—ë–Ω–æ–≥–æ.<br><br>–í—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Ä–Ω—ã–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ —Ç–∏–ø–∞—Ö –∏ —Å–æ—Å—Ç–∞–≤–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π.`,
      options: [
        "1) (1) ‚Äî –ø—Ä–æ—Å—Ç–æ–µ, –æ—Å–ª–æ–∂–Ω—ë–Ω–Ω–æ–µ –æ–¥–Ω–æ—Ä–æ–¥–Ω—ã–º–∏ —á–ª–µ–Ω–∞–º–∏.",
        "2) (2) ‚Äî —Å–ª–æ–∂–Ω–æ–µ –±–µ—Å—Å–æ—é–∑–Ω–æ–µ.",
        "3) –í (3) ‚Äî –¥–≤–µ –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—Å–Ω–æ–≤—ã.",
        "4) (4) ‚Äî –°–ü–ü —Å –ø—Ä–∏–¥–∞—Ç–æ—á–Ω—ã–º –ø—Ä–∏—á–∏–Ω—ã.",
        "5) –í (5) –ø–µ—Ä–≤–∞—è —á–∞—Å—Ç—å ‚Äî —Å–æ—Å—Ç–∞–≤–Ω–æ–µ –≥–ª–∞–≥–æ–ª—å–Ω–æ–µ —Å–∫–∞–∑—É–µ–º–æ–µ."
      ],
      correct: [1, 2, 5]
    },
    {
      id: "rq4",
      topic: "–û—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—è (—Å—É—Ñ—Ñ–∏–∫—Å—ã, –ø—Ä–∏—Å—Ç–∞–≤–∫–∏, –æ–∫–æ–Ω—á–∞–Ω–∏—è)",
      text: `–£–∫–∞–∂–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –¥–∞–Ω–æ –≤–µ—Ä–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –Ω–∞–ø–∏—Å–∞–Ω–∏—è –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Å–ª–æ–≤–∞. –ó–∞–ø–∏—à–∏—Ç–µ –Ω–æ–º–µ—Ä–∞ —ç—Ç–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤.<br><br>
1) –î–û–í–ï–†–ß–ò–í–´–ô ‚Äì –ø—Ä–∞–≤–æ–ø–∏—Å–∞–Ω–∏–µ –≥–ª–∞—Å–Ω–æ–π –ò –≤ —Å—É—Ñ—Ñ–∏–∫—Å–µ –ø—Ä–∏—á–∞—Å—Ç–∏—è –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å—é –∫–æ II —Å–ø—Ä—è–∂–µ–Ω–∏—é –≥–ª–∞–≥–æ–ª–∞.<br>
2) –†–ê–°–¢–£–©–ò–ô ‚Äì –≤ –∫–æ—Ä–Ω–µ —Å–ª–æ–≤–∞ —Å —á–µ—Ä–µ–¥—É—é—â–µ–π—Å—è –≥–ª–∞—Å–Ω–æ–π –ø–µ—Ä–µ–¥ -–°–¢- –ø–∏—à–µ—Ç—Å—è –±—É–∫–≤–∞ –ê.<br>
3) –í–´–¢–†–ò–¢–ï (—Å—Ç–æ–ª) ‚Äì –≤ —Ñ–æ—Ä–º–µ –±—É–¥—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ 2-–≥–æ –ª–∏—Ü–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —á–∏—Å–ª–∞ –≥–ª–∞–≥–æ–ª–∞ II —Å–ø—Ä—è–∂–µ–Ω–∏—è –ø–∏—à–µ—Ç—Å—è –æ–∫–æ–Ω—á–∞–Ω–∏–µ -–ò–¢–ï.<br>
4) –ë–ï–ó–´–ù–ò–¶–ò–ê–¢–ò–í–ù–´–ô ‚Äì –ø–æ—Å–ª–µ —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω–æ–π –ø—Ä–∏—Å—Ç–∞–≤–∫–∏, –æ–∫–∞–Ω—á–∏–≤–∞—é—â–µ–π—Å—è –Ω–∞ —Å–æ–≥–ª–∞—Å–Ω—É—é, –ø–∏—à–µ—Ç—Å—è –±—É–∫–≤–∞ –´.<br>
5) (–Ω–∞) –ë–û–ß–û–ö ‚Äì –≤ –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –∏–º—ë–Ω —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ—Å–ª–µ —à–∏–ø—è—â–∏—Ö –ø–æ–¥ —É–¥–∞—Ä–µ–Ω–∏–µ–º –ø–∏—à–µ—Ç—Å—è –±—É–∫–≤–∞ –û.`,
      options: ["1) 1,2", "2) 2,4", "3) 2,3,4", "4) 2,5"],
      correct: [2]
    },
    {
      id: "rq5",
      topic: "–°—Ä–µ–¥—Å—Ç–≤–∞ –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏",
      text: `–£–∫–∞–∂–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤, –≤ –∫–æ—Ç–æ—Ä—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤–æ–º –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Ä–µ—á–∏ —è–≤–ª—è–µ—Ç—Å—è –º–µ—Ç–∞—Ñ–æ—Ä–∞.<br><br>
1) –ü—É—Å—Ç—ã–Ω—è –±—ã–ª–∞ –µ—ë —Ä–æ–¥–∏–Ω–æ–π, –∞ –≥–µ–æ–≥—Ä–∞—Ñ–∏—è ‚Äì –ø–æ—ç–∑–∏–µ–π.<br>
2) –ü–µ—Å–æ–∫ –ø–æ–¥—Ö–æ–¥–∏–ª –∫ –ø–æ–¥–æ–∫–æ–Ω–Ω–∏–∫–∞–º –¥–æ–º–æ–≤, –ª–µ–∂–∞–ª –±—É–≥—Ä–∞–º–∏ –Ω–∞ –¥–≤–æ—Ä–∞—Ö –∏ —Ç–æ—á–∏–ª –¥—ã—Ö–∞–Ω–∏–µ –ª—é–¥–µ–π.<br>
3) –ú–∞—Ä–∏—è –ù–∏–∫–∏—Ñ–æ—Ä–æ–≤–Ω–∞ —É–≤–∏–¥–µ–ª–∞ —Ç—è–∂–∫–∏–π –∏ –ø–æ—á—Ç–∏ –Ω–µ–Ω—É–∂–Ω—ã–π —Ç—Ä—É–¥, –ø–æ—Ç–æ–º—É —á—Ç–æ —Ä–∞—Å—á–∏—â–µ–Ω–Ω—ã–µ –º–µ—Å—Ç–∞ —Å–Ω–æ–≤–∞ –∑–∞–≤–∞–ª–∏–≤–∞–ª–∏—Å—å –ø–µ—Å–∫–æ–º, —É–≤–∏–¥–µ–ª–∞ –º–æ–ª—á–∞–ª–∏–≤—É—é –±–µ–¥–Ω–æ—Å—Ç—å –∏ —Å–º–∏—Ä–µ–Ω–Ω–æ–µ –æ—Ç—á–∞—è–Ω–∏–µ.<br>
4) –®–∫–æ–ª–∞ –ú–∞—Ä–∏–∏ –ù–∏–∫–∏—Ñ–æ—Ä–æ–≤–Ω—ã –≤—Å–µ–≥–¥–∞ –±—ã–ª–∞ –ø–æ–ª–Ω–∞ –Ω–µ —Ç–æ–ª—å–∫–æ –¥–µ—Ç—å–º–∏, –Ω–æ –∏ –≤–∑—Ä–æ—Å–ª—ã–º–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å–ª—É—à–∞–ª–∏ —á—Ç–µ–Ω–∏–µ —É—á–∏—Ç–µ–ª—å–Ω–∏—Ü—ã –ø—Ä–æ –º—É–¥—Ä–æ—Å—Ç—å –∂–∏—Ç—å –≤ –ø–µ—Å—á–∞–Ω–æ–π —Å—Ç–µ–ø–∏.<br>
5) –ú–∞—Ä–∏—è –ù–∏–∫–∏—Ñ–æ—Ä–æ–≤–Ω–∞ –∑–∞–¥—É–º–∞–ª–∞—Å—å: ¬´–ù–µ—É–∂–µ–ª–∏ –º–æ–ª–æ–¥–æ—Å—Ç—å –ø—Ä–∏–¥—ë—Ç—Å—è –ø–æ—Ö–æ—Ä–æ–Ω–∏—Ç—å –≤ –ø–µ—Å—á–∞–Ω–æ–π –ø—É—Å—Ç—ã–Ω–µ –∏ —É–º–µ—Ä–µ—Ç—å –≤ –∫—É—Å—Ç–∞—Ä–Ω–∏–∫–µ?..¬ª`,
      options: ["1) 1,2,5", "2) 1,3", "3) 1,4,5"],
      correct: [1]
    }
  ],

  // === –ú–ê–¢–ï–ú–ê–¢–ò–ö–ê –û–ì–≠ ===
  math_oge: [
    {
      id: "mo1",
      topic: "–í—ã—á–∏—Å–ª–µ–Ω–∏—è (–∫–æ—Ä–Ω–∏ –∏ —Å—Ç–µ–ø–µ–Ω–∏)",
      text: `–ù–∞–π–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è: $\\displaystyle \\frac{\\sqrt{99b^{7}}\\cdot\\sqrt{11a^{8}}}{\\sqrt{a^{2}b^{3}}}$, –ø—Ä–∏ $a=2$, $b=3$.`,
      options: ["1) 2736", "2) 2376", "3) 3760"],
      correct: [2]
    },
    {
      id: "mo2",
      topic: "–ë–µ—Ç–∞-—Ä–∞—Å–ø–∞–¥",
      text: "–í —Ö–æ–¥–µ –±–µ—Ç–∞-—Ä–∞—Å–ø–∞–¥–∞ —Ä–∞–¥–∏–æ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∏–∑–æ—Ç–æ–ø–∞ –ê –∫–∞–∂–¥—ã–µ 8 –º–∏–Ω—É—Ç –ø–æ–ª–æ–≤–∏–Ω–∞ –µ–≥–æ –∞—Ç–æ–º–æ–≤ –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –º–∞—Å—Å—ã –ø—Ä–µ–æ–±—Ä–∞–∑—É—é—Ç—Å—è –≤ –∞—Ç–æ–º—ã —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ –∏–∑–æ—Ç–æ–ø–∞ –ë. –í –Ω–∞—á–∞–ª—å–Ω—ã–π –º–æ–º–µ–Ω—Ç –º–∞—Å—Å–∞ –∏–∑–æ—Ç–æ–ø–∞ –ê —Å–æ—Å—Ç–∞–≤–ª—è–ª–∞ 160 –º–≥. –ù–∞–π–¥–∏—Ç–µ –º–∞—Å—Å—É –æ–±—Ä–∞–∑–æ–≤–∞–≤—à–µ–≥–æ—Å—è –∏–∑–æ—Ç–æ–ø–∞ –ë —á–µ—Ä–µ–∑ 40 –º–∏–Ω—É—Ç. –û—Ç–≤–µ—Ç –¥–∞–π—Ç–µ –≤ –º–∏–ª–ª–∏–≥—Ä–∞–º–º–∞—Ö.",
      options: ["1) 155", "2) 160", "3) 150"],
      correct: [1]
    },
    {
      id: "mo3",
      topic: "–£–≥–ª—ã —Ç—Ä–∞–ø–µ—Ü–∏–∏",
      text: "–ú–µ–Ω—å—à–∏–π —É–≥–æ–ª —Ä–∞–≤–Ω–æ–±–µ–¥—Ä–µ–Ω–Ω–æ–π —Ç—Ä–∞–ø–µ—Ü–∏–∏, –µ—Å–ª–∏ –¥–≤–∞ —É–≥–ª–∞ –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫–∞–∫ 1:2.",
      options: ["1) 60¬∞", "2) 120¬∞", "3) 30¬∞"],
      correct: [1]
    },
    {
      id: "mo4",
      topic: "–ö–ª–µ—Ç—á–∞—Ç–∞—è –±—É–º–∞–≥–∞",
      text: `–ù–∞ –∫–ª–µ—Ç—á–∞—Ç–æ–π –±—É–º–∞–≥–µ —Å —Ä–∞–∑–º–µ—Ä–æ–º –∫–ª–µ—Ç–∫–∏ 1√ó1 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∞ —Ñ–∏–≥—É—Ä–∞. –ù–∞–π–¥–∏—Ç–µ –¥–ª–∏–Ω—É –æ—Ç—Ä–µ–∑–∫–∞ AB.<br><br>${GRID_SVG}`,
      options: ["1) 1,1", "2) 1,2", "3) 1"],
      correct: [3]
    },
    {
      id: "mo5",
      topic: "–û–∫—Ä—É–∂–Ω–æ—Å—Ç–∏",
      text: `–ö–∞–∫–∏–µ –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π –≤–µ—Ä–Ω—ã?<br><br>
1) –í–ø–∏—Å–∞–Ω–Ω—ã–µ —É–≥–ª—ã, –æ–ø–∏—Ä–∞—é—â–∏–µ—Å—è –Ω–∞ –æ–¥–Ω—É –∏ —Ç—É –∂–µ —Ö–æ—Ä–¥—É –æ–∫—Ä—É–∂–Ω–æ—Å—Ç–∏, —Ä–∞–≤–Ω—ã.<br>
2) –ï—Å–ª–∏ —Ä–∞–¥–∏—É—Å—ã –¥–≤—É—Ö –æ–∫—Ä—É–∂–Ω–æ—Å—Ç–µ–π —Ä–∞–≤–Ω—ã 5 –∏ 7, –∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –∏—Ö —Ü–µ–Ω—Ç—Ä–∞–º–∏ —Ä–∞–≤–Ω–æ 3, —Ç–æ —ç—Ç–∏ –æ–∫—Ä—É–∂–Ω–æ—Å—Ç–∏ –Ω–µ –∏–º–µ—é—Ç –æ–±—â–∏—Ö —Ç–æ—á–µ–∫.<br>
3) –ï—Å–ª–∏ —Ä–∞–¥–∏—É—Å –æ–∫—Ä—É–∂–Ω–æ—Å—Ç–∏ —Ä–∞–≤–µ–Ω 3, –∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –æ–∫—Ä—É–∂–Ω–æ—Å—Ç–∏ –¥–æ –ø—Ä—è–º–æ–π —Ä–∞–≤–Ω–æ 2, —Ç–æ —ç—Ç–∞ –ø—Ä—è–º–∞—è –∏ –æ–∫—Ä—É–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç—Å—è.<br>
4) –ï—Å–ª–∏ –≤–ø–∏—Å–∞–Ω–Ω—ã–π —É–≥–æ–ª —Ä–∞–≤–µ–Ω 30¬∞, —Ç–æ –¥—É–≥–∞ –æ–∫—Ä—É–∂–Ω–æ—Å—Ç–∏, –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –æ–ø–∏—Ä–∞–µ—Ç—Å—è —ç—Ç–æ—Ç —É–≥–æ–ª, —Ä–∞–≤–Ω–∞ 60¬∞.<br><br>
–ï—Å–ª–∏ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π –Ω–µ—Å–∫–æ–ª—å–∫–æ, –∑–∞–ø–∏—à–∏—Ç–µ –∏—Ö –Ω–æ–º–µ—Ä–∞ –≤ –ø–æ—Ä—è–¥–∫–µ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—è.`,
      options: ["1) 1,3", "2) 3,4", "3) 1,4"],
      correct: [2]
    }
  ]
};

// === –û—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ (—Ä–µ–Ω–¥–µ—Ä, –ø—Ä–æ–≤–µ—Ä–∫–∞, MathJax) ===
const QUESTIONS = BANKS[SUBJECT] || BANKS.rus_oge;
const quizRoot = document.getElementById("quiz");

function renderQuiz() {
  quizRoot.innerHTML = "";
  QUESTIONS.forEach((q, idx) => {
    const isMultiple = q.correct.length > 1;
    const card = document.createElement("section");
    card.className = "card";

    const title = document.createElement("div");
    title.className = "card-title";
    title.innerHTML = `<span class="q-index">–í–æ–ø—Ä–æ—Å ${idx + 1}</span><span class="topic">${q.topic}</span>`;

    const qtext = document.createElement("div");
    qtext.className = "q-text";
    qtext.innerHTML = q.text;

    const opts = document.createElement("div");
    opts.className = "options";
    q.options.forEach((optText, i) => {
      const id = `${q.id}_${i + 1}`;
      const wrap = document.createElement("label");
      wrap.className = "option";

      const input = document.createElement("input");
      input.type = isMultiple ? "checkbox" : "radio";
      input.name = q.id;
      input.value = (i + 1).toString();
      input.id = id;

      const span = document.createElement("span");
      span.className = "option-label";
      span.textContent = optText;

      wrap.appendChild(input);
      wrap.appendChild(span);
      opts.appendChild(wrap);
    });

    card.appendChild(title);
    card.appendChild(qtext);
    card.appendChild(opts);
    quizRoot.appendChild(card);
  });

  if (window.MathJax && window.MathJax.typesetPromise) {
    window.MathJax.typesetPromise();
  }
}

function getUserSelections() {
  const selections = {};
  QUESTIONS.forEach(q => {
    const inputs = Array.from(document.querySelectorAll(`input[name="${q.id}"]`));
    const picked = inputs.filter(i => i.checked).map(i => parseInt(i.value, 10));
    selections[q.id] = picked;
  });
  return selections;
}

function arraysEqualAsSets(a, b) {
  if (a.length !== b.length) return false;
  const sa = new Set(a);
  for (const x of b) if (!sa.has(x)) return false;
  return true;
}

function computeTopics() {
  const selections = getUserSelections();
  const good = new Set();
  const bad = new Set();

  QUESTIONS.forEach(q => {
    const picked = selections[q.id] || [];
    if (picked.length === 0) bad.add(q.topic);
    else if (arraysEqualAsSets(picked, q.correct)) good.add(q.topic);
    else bad.add(q.topic);
  });

  const goodText = good.size ? [...good].join(", ") : "–Ω–µ—Ç üò±";
  const badText = bad.size ? [...bad].join(", ") : "–Ω–µ—Ç üò±";
  return { good: goodText, bad: badText };
}

document.getElementById("submitBtn").addEventListener("click", async () => {
  const result = computeTopics();
  if (!CLIENT_ID) {
    alert("–ù–µ –ø–µ—Ä–µ–¥–∞–Ω client_id. –û—Ç–∫—Ä–æ–π—Ç–µ –º–∏–Ω–∏-–∞–ø–ø —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –±–æ—Ç–∞.");
    return;
  }

  try {
    const res = await fetch(WEBHOOK_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        client_id: CLIENT_ID,
        group: GROUP,
        subject: SUBJECT,
        good: result.good,
        bad: result.bad
      })
    });
    const payload = await res.json();

    if (!res.ok && payload?.code === "already_submitted") {
      quizRoot.innerHTML = `<div class="done-message">
        –í—ã —É–∂–µ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ —Ç–µ—Å—Ç –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É: <b>${payload.subject}</b>.<br/>
        –í —Ä–∞–º–∫–∞—Ö –∞–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ç–µ—Å—Ç.
      </div>`;
      return;
    }

    quizRoot.innerHTML = `<div class="done-message">
      –°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–≤–µ—Ç—ã, –º–æ–∂–µ—Ç–µ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è –≤ –±–æ—Ç–∞!
    </div>`;
  } catch (err) {
    console.error(err);
    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.");
  }
});

renderQuiz();
